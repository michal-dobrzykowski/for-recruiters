<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3.js Animation Example with Zoom on Group</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    #container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 50px auto;
      border: 1px solid #ccc;
      cursor: grab;
    }

    #container:active{
      cursor: grabbing;
    }

    .square {
      fill: blue;
      cursor: pointer;
    }
  </style>
</head>
<body>

<svg id="container" width="400" height="400">
  <g id="zoomable"></g>
</svg>
<button id="addSquare">Dodaj kwadrat</button>
<button id="removeSquare">Usuń kwadrat</button>
<button id="randomizePosition">Losuj pozycję</button>
<button id="zoomIn">+</button>
<button id="zoomOut">-</button>

<script>
  let svg = d3.select("#container"),
      zoomableGroup = svg.select("#zoomable"),
      zoomLevel = 1,
      zoom = d3.zoom()
        .scaleExtent([1, 10])
        .translateExtent([[0, 0], [400, 400]])
        .on("zoom", (event) => {
          zoomableGroup.attr("transform", event.transform);
        });

  svg.call(zoom);

  
  function dragStarted(event, d) {
    d3.select(this).raise();
    // event.sourceEvent.stopPropagation(); // prevent zoom
  }

  function dragging(event, d) {
    d.x += event.dx;
    d.y += event.dy;
    d3.select(this)
        .attr("x", d.x)
        .attr("y", d.y);
  }

  function dragEnded() {
      // Dragging ended
  }

  function addSquare() {
    zoomableGroup.append("rect")
      .attr("class", "square")
      .attr("width", 50)
      .attr("height", 50)
      .datum({ x: 175, y: 175 })
      .attr("x", 175)
      .attr("y", 175)
      .style("opacity", 0)
      .call(d3.drag()
          .on("start", dragStarted)
          .on("drag", dragging)
          .on("end", dragEnded)
      )
      .transition()
      .duration(1000)
      .style("opacity", 1);
  }

  function removeSquare() {
    zoomableGroup.select(".square")
      .transition()
      .duration(1000)
      .style("opacity", 0)
      .remove();
  }

  function randomizePosition() {
    let square = zoomableGroup.select(".square");

    square.transition()
      .duration(1000)
      .attr("x", Math.random() * 300)
      .attr("y", Math.random() * 300);
  }

  // Zoom in function
  function zoomIn() {
    zoomLevel = Math.min(zoomLevel + 0.1, 10);
    svg.transition().call(zoom.scaleTo, zoomLevel);
  }

  // Zoom out function
  function zoomOut() {
    zoomLevel = Math.max(zoomLevel - 0.1, 1);
    svg.transition().call(zoom.scaleTo, zoomLevel);
  }

  document.getElementById("zoomIn").addEventListener("click", zoomIn);
  document.getElementById("zoomOut").addEventListener("click", zoomOut);
  document.getElementById("addSquare").addEventListener("click", addSquare);
  document.getElementById("removeSquare").addEventListener("click", removeSquare);
  document.getElementById("randomizePosition").addEventListener("click", randomizePosition);
</script>

</body>
</html>